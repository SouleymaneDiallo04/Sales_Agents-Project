# Configuration pour le fine-tuning de modèles pré-entraînés

# Stratégie d'adaptation
adaptation:
  strategy: "feature_extractor"  # feature_extractor, partial_reinit, full_reinit
  freeze_layers: 2               # Nombre de couches à geler initialement
  unfreeze_after: 0.5            # Dégeler après 50% du training (0 = jamais, 1 = début)
  
  # Pour les modèles venant de CartPole (4 obs) -> Pricing (9 obs)
  observation_adaptation: "padding"  # padding, interpolation, learned
  action_adaptation: "extend"        # extend, reduce, remap

# Hyperparamètres de fine-tuning
finetune:
  # Learning rate (beaucoup plus petit que l'entraînement normal)
  learning_rate: 0.0001
  learning_rate_schedule: "constant"  # constant, linear, cosine
  
  # Paramètres d'optimisation
  n_steps: 1024
  batch_size: 64
  n_epochs: 5
  gamma: 0.99
  gae_lambda: 0.95
  
  # Clipping (plus conservateur)
  clip_range: 0.1
  clip_range_vf: null
  
  # Entropy (pour l'exploration)
  ent_coef: 0.01
  ent_coef_schedule: "constant"
  
  # Normalisation
  normalize_advantage: true
  max_grad_norm: 0.5

# Configuration de l'entraînement
training:
  total_timesteps: 50000        # Bien moins que l'entraînement from-scratch
  n_envs: 4                     # Environnements parallèles
  seed: 42                      # Pour la reproductibilité
  
  # Évaluation
  eval_freq: 5000               # Évaluer toutes les 5000 steps
  n_eval_episodes: 5            # Nombre d'épisodes d'évaluation
  save_freq: 10000              # Sauvegarde toutes les 10000 steps
  
  # Callbacks
  use_tensorboard: true
  use_checkpoints: true
  use_early_stopping: false
  early_stopping_patience: 10

# Configuration par modèle source
model_specific:
  ppo_cartpole:
    description: "PPO pré-entraîné sur CartPole-v1"
    recommended_adaptation: "feature_extractor"
    recommended_freeze_layers: 2
    expected_improvement: "30-50%"  # Amélioration attendue vs from-scratch
    
  ppo_lunarlander:
    description: "PPO pré-entraîné sur LunarLander-v2"
    recommended_adaptation: "partial_reinit"
    recommended_freeze_layers: 1
    expected_improvement: "40-60%"
    
  dqn_cartpole:
    description: "DQN pré-entraîné sur CartPole-v1"
    recommended_adaptation: "partial_reinit"
    recommended_freeze_layers: 1
    warning: "DQN peut être moins stable pour le transfer"
    
  a2c_cartpole:
    description: "A2C pré-entraîné sur CartPole-v1"
    recommended_adaptation: "feature_extractor"
    recommended_freeze_layers: 2

# Stratégies de fine-tuning avancées
advanced:
  # Phase 1: Gel complet sauf dernière couche
  phase1:
    steps: 10000
    learning_rate: 0.00005
    freeze_layers: "all_except_last"
    
  # Phase 2: Dégel progressif
  phase2:
    steps: 30000
    learning_rate: 0.0001
    unfreeze_schedule: "linear"
    
  # Phase 3: Réglage fin
  phase3:
    steps: 10000
    learning_rate: 0.00001
    freeze_layers: 0

# Configuration du logging
logging:
  tensorboard_log: "./logs/tensorboard_finetune/"
  verbose: 1
  log_interval: 10
  
  # Métriques à logger
  metrics:
    - "train/reward"
    - "train/episode_length"
    - "train/loss"
    - "train/entropy_loss"
    - "train/value_loss"
    - "train/policy_loss"
    - "train/learning_rate"
    - "eval/mean_reward"
    - "eval/std_reward"
    
  # Métriques custom pour le pricing
  custom_metrics:
    - "pricing/mean_price"
    - "pricing/stock_level"
    - "pricing/profit"
    - "pricing/price_variability"
    - "pricing/action_distribution"

# Notes importantes
notes: |
  Ce fichier de configuration est optimisé pour le fine-tuning de modèles
  pré-entraînés SB3 Zoo vers l'environnement EcommercePricing.
  
  Recommandations:
  1. Commencez avec ppo_cartpole pour des résultats stables
  2. Utilisez un learning rate 10x plus petit que l'entraînement normal
  3. Geler les premières couches prévient le catastrophic forgetting
  4. Le fine-tuning nécessite beaucoup moins de timesteps que l'entraînement from-scratch
  
  Performances attendues:
  - Accélération: 5-10x plus rapide
  - Meilleures performances initiales
  - Plus grande stabilité